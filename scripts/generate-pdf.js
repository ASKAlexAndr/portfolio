const puppeteer = require('puppeteer');
const path = require('path');
const fs = require('fs');

async function generatePDF(htmlFile, outputFile, language = null) {
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  try {
    const page = await browser.newPage();
    
    // –ü—É—Ç—å –∫ HTML —Ñ–∞–π–ª—É
    const htmlPath = path.join(__dirname, '../public/cv', htmlFile);
    const htmlUrl = `file://${htmlPath}`;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º HTML —Ñ–∞–π–ª
    await page.goto(htmlUrl, { waitUntil: 'networkidle0' });
    
    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —è–∑—ã–∫, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ URL
    if (language) {
      await page.goto(`${htmlUrl}?lang=${language}`, { waitUntil: 'networkidle0' });
      
      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      await page.waitForFunction(() => {
        return !document.querySelector('.loading') && document.querySelector('header');
      }, { timeout: 10000 });
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      margin: {
        top: '20mm',
        right: '20mm',
        bottom: '20mm',
        left: '20mm'
      }
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF —Ñ–∞–π–ª
    const outputPath = path.join(__dirname, '../public/cv', outputFile);
    fs.writeFileSync(outputPath, pdfBuffer);
    
    console.log(`‚úÖ PDF —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: ${outputPath}`);
    
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –¥–ª—è ${htmlFile}:`, error);
  } finally {
    await browser.close();
  }
}

async function generateAllPDFs() {
  console.log('üöÄ –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é PDF —Ñ–∞–π–ª–æ–≤ –∏–∑ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–≥–æ HTML...');
  
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä—É—Å—Å–∫—É—é –≤–µ—Ä—Å–∏—é
    await generatePDF('cv.html', 'cv-ru.pdf', 'ru');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–Ω–≥–ª–∏–π—Å–∫—É—é –≤–µ—Ä—Å–∏—é
    await generatePDF('cv.html', 'cv-en.pdf', 'en');
  
  console.log('üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
}

generateAllPDFs();
